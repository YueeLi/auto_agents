"""
LangGraph Graph å…¨é¢çŸ¥è¯†ç‚¹ä¸å®æˆ˜æ¼”ç¤º
=====================================================

## å…³é”®è¦ç‚¹æ¢³ç†

### æ ¸å¿ƒæ¦‚å¿µ
1. **å›¾å®šä¹‰**ï¼šä½¿ç”¨ `StateGraph` ç±»å®šä¹‰å›¾ç»“æ„ï¼Œæ”¯æŒçŠ¶æ€é©±åŠ¨çš„å·¥ä½œæµ [1](#0-0) 
2. **èŠ‚ç‚¹ç³»ç»Ÿ**ï¼šPython å‡½æ•°ä½œä¸ºèŠ‚ç‚¹ï¼Œæ¥æ”¶çŠ¶æ€å¹¶è¿”å›çŠ¶æ€æ›´æ–° [2](#0-1) 
3. **è¾¹è¿æ¥**ï¼šPython å‡½æ•°å†³å®šä¸‹ä¸€ä¸ªæ‰§è¡Œçš„èŠ‚ç‚¹ï¼Œæ”¯æŒæ¡ä»¶åˆ†æ”¯ [3](#0-2) 

### æ‰§è¡Œæœºåˆ¶
4. **è¶…çº§æ­¥éª¤**ï¼šåŸºäº Pregel ç³»ç»Ÿçš„æ¶ˆæ¯ä¼ é€’æ¨¡å‹ï¼Œç¦»æ•£æ‰§è¡Œæ­¥éª¤ [4](#0-3) 
5. **å›¾ç¼–è¯‘**ï¼šé€šè¿‡ `.compile()` æ–¹æ³•ç¼–è¯‘å›¾ï¼Œè¿›è¡Œç»“æ„æ£€æŸ¥å’Œè¿è¡Œæ—¶é…ç½® [5](#0-4) 
6. **å¹¶è¡Œæ‰§è¡Œ**ï¼šåŒä¸€è¶…çº§æ­¥éª¤å†…çš„èŠ‚ç‚¹å¹¶è¡Œæ‰§è¡Œï¼Œé¡ºåºèŠ‚ç‚¹å±äºä¸åŒè¶…çº§æ­¥éª¤ [6](#0-5) 

### æ§åˆ¶æµç‰¹æ€§
7. **æ¡ä»¶è¾¹**ï¼šåŸºäºçŠ¶æ€åŠ¨æ€è·¯ç”±åˆ°ä¸åŒèŠ‚ç‚¹ [7](#0-6) 
8. **Send API**ï¼šæ”¯æŒ map-reduce æ¨¡å¼ï¼ŒåŠ¨æ€åˆ›å»ºå¤šä¸ªå¹¶è¡Œä»»åŠ¡ [8](#0-7) 
9. **Command API**ï¼šç»“åˆçŠ¶æ€æ›´æ–°å’Œæ§åˆ¶æµè·³è½¬ [9](#0-8) 

### é«˜çº§æ¶æ„
10. **å­å›¾ç³»ç»Ÿ**ï¼šå›¾ä½œä¸ºèŠ‚ç‚¹åµŒå…¥å…¶ä»–å›¾ï¼Œæ”¯æŒå¤æ‚ç³»ç»Ÿæ„å»º [10](#0-9) 
11. **å¤šä»£ç†æ¶æ„**ï¼šé€šè¿‡å­å›¾å’Œ Command å®ç°ä»£ç†é—´é€šä¿¡ [11](#0-10) 
12. **äººæœºäº¤äº’**ï¼šæ”¯æŒä¸­æ–­å’Œæ¢å¤æœºåˆ¶ï¼Œå®ç°äººå·¥å¹²é¢„å·¥ä½œæµ [12](#0-11) 

## æ ¸å¿ƒæ¦‚å¿µè¯¦è§£

### 1. å›¾å®šä¹‰ï¼šStateGraph æ¶æ„åŸºç¡€

LangGraph çš„æ ¸å¿ƒæ˜¯ `StateGraph` ç±»ï¼Œå®ƒå®šä¹‰äº†çŠ¶æ€é©±åŠ¨çš„å›¾ç»“æ„ [13](#0-12) ï¼š

**å›¾åˆå§‹åŒ–æ¨¡å¼**ï¼š
- çŠ¶æ€æ¨¡å¼å®šä¹‰ï¼šæ”¯æŒ `TypedDict`ã€`Pydantic BaseModel`ã€`dataclass`
- é…ç½®æ¨¡å¼ï¼šå¯é€‰çš„è¿è¡Œæ—¶é…ç½®å‚æ•°å®šä¹‰
- è¾“å…¥è¾“å‡ºæ¨¡å¼ï¼šæ”¯æŒä¸åŒçš„è¾“å…¥è¾“å‡ºç»“æ„

**åŸºç¡€å›¾æ„å»ºæµç¨‹** [14](#0-13) ï¼š
```python
graph_builder = StateGraph(State)
```

### 2. èŠ‚ç‚¹ç³»ç»Ÿï¼šè®¡ç®—å•å…ƒçš„æ ¸å¿ƒ

èŠ‚ç‚¹æ˜¯å›¾ä¸­çš„è®¡ç®—å•å…ƒï¼Œé€šå¸¸æ˜¯ Python å‡½æ•° [15](#0-14) ï¼š

**èŠ‚ç‚¹å‡½æ•°ç­¾å**ï¼š
- ç¬¬ä¸€ä¸ªå‚æ•°ï¼šå½“å‰çŠ¶æ€
- ç¬¬äºŒä¸ªå‚æ•°ï¼ˆå¯é€‰ï¼‰ï¼šé…ç½®ä¿¡æ¯
- è¿”å›å€¼ï¼šçŠ¶æ€æ›´æ–°å­—å…¸

**èŠ‚ç‚¹æ·»åŠ æ–¹å¼** [16](#0-15) ï¼š
- æ˜¾å¼å‘½åï¼š`builder.add_node("node_name", function)`
- è‡ªåŠ¨å‘½åï¼š`builder.add_node(function)` ä½¿ç”¨å‡½æ•°å

### 3. è¾¹è¿æ¥ï¼šæ§åˆ¶æµçš„å®ç°

è¾¹å†³å®šäº†å›¾çš„æ‰§è¡Œæµç¨‹ï¼Œæ”¯æŒå¤šç§è¿æ¥æ¨¡å¼ï¼š

**å›ºå®šè¾¹**ï¼šç›´æ¥è¿æ¥ä¸¤ä¸ªèŠ‚ç‚¹ [17](#0-16) 

**æ¡ä»¶è¾¹**ï¼šåŸºäºçŠ¶æ€åŠ¨æ€è·¯ç”± [18](#0-17) 

**å…¥å£ç‚¹é…ç½®**ï¼šä»è™šæ‹Ÿ START èŠ‚ç‚¹å¼€å§‹ [17](#0-16) 

## æ‰§è¡Œæœºåˆ¶è¯¦è§£

### 4. è¶…çº§æ­¥éª¤ï¼šPregel æ¶ˆæ¯ä¼ é€’æ¨¡å‹

LangGraph åŸºäº Google Pregel ç³»ç»Ÿå®ç°æ¶ˆæ¯ä¼ é€’ [4](#0-3) ï¼š

**æ‰§è¡Œæ¨¡å‹ç‰¹ç‚¹**ï¼š
- ç¦»æ•£çš„è¶…çº§æ­¥éª¤æ‰§è¡Œ
- å¹¶è¡ŒèŠ‚ç‚¹åœ¨åŒä¸€è¶…çº§æ­¥éª¤å†…æ‰§è¡Œ
- é¡ºåºèŠ‚ç‚¹å±äºä¸åŒè¶…çº§æ­¥éª¤
- èŠ‚ç‚¹çŠ¶æ€ï¼š`inactive` â†’ `active` â†’ `inactive`

**ç»ˆæ­¢æ¡ä»¶**ï¼šæ‰€æœ‰èŠ‚ç‚¹å¤„äº `inactive` çŠ¶æ€ä¸”æ— æ¶ˆæ¯ä¼ è¾“æ—¶ç»ˆæ­¢

### 5. å›¾ç¼–è¯‘ï¼šç»“æ„éªŒè¯ä¸é…ç½®

ç¼–è¯‘æ˜¯å›¾æ‰§è¡Œå‰çš„å¿…è¦æ­¥éª¤ [5](#0-4) ï¼š

**ç¼–è¯‘åŠŸèƒ½**ï¼š
- å›¾ç»“æ„éªŒè¯ï¼ˆæ— å­¤ç«‹èŠ‚ç‚¹ç­‰ï¼‰
- è¿è¡Œæ—¶å‚æ•°é…ç½®ï¼ˆcheckpointerã€æ–­ç‚¹ç­‰ï¼‰
- ç”Ÿæˆå¯æ‰§è¡Œçš„å›¾å¯¹è±¡

**ç¼–è¯‘é…ç½®é€‰é¡¹**ï¼š
- `checkpointer`ï¼šçŠ¶æ€æŒä¹…åŒ–
- `interrupt_before_nodes`ï¼šèŠ‚ç‚¹å‰æ–­ç‚¹
- `interrupt_after_nodes`ï¼šèŠ‚ç‚¹åæ–­ç‚¹

### 6. å¹¶è¡Œæ‰§è¡Œï¼šæ€§èƒ½ä¼˜åŒ–æœºåˆ¶

å›¾æ”¯æŒèŠ‚ç‚¹çš„å¹¶è¡Œæ‰§è¡Œä»¥æé«˜æ€§èƒ½ [19](#0-18) ï¼š

**å¹¶è¡Œæ‰§è¡Œç‰¹ç‚¹**ï¼š
- åŒä¸€è¶…çº§æ­¥éª¤å†…çš„èŠ‚ç‚¹å¹¶è¡Œæ‰§è¡Œ
- äº‹åŠ¡æ€§ï¼šä»»ä¸€èŠ‚ç‚¹å¤±è´¥åˆ™æ•´ä¸ªè¶…çº§æ­¥éª¤å¤±è´¥
- ä½¿ç”¨ checkpointer æ—¶æˆåŠŸèŠ‚ç‚¹çš„ç»“æœä¼šä¿å­˜

## æ§åˆ¶æµç‰¹æ€§è¯¦è§£

### 7. æ¡ä»¶è¾¹ï¼šåŠ¨æ€è·¯ç”±å®ç°

æ¡ä»¶è¾¹å…è®¸åŸºäºçŠ¶æ€åŠ¨æ€å†³å®šä¸‹ä¸€ä¸ªæ‰§è¡ŒèŠ‚ç‚¹ [18](#0-17) ï¼š

**è·¯ç”±å‡½æ•°ç‰¹ç‚¹**ï¼š
- æ¥æ”¶å½“å‰çŠ¶æ€ä½œä¸ºå‚æ•°
- è¿”å›å€¼ä½œä¸ºç›®æ ‡èŠ‚ç‚¹åç§°
- æ”¯æŒå­—å…¸æ˜ å°„è¿”å›å€¼åˆ°èŠ‚ç‚¹åç§°

### 8. Send APIï¼šMap-Reduce æ¨¡å¼æ”¯æŒ

Send API æ”¯æŒåŠ¨æ€åˆ›å»ºå¤šä¸ªå¹¶è¡Œä»»åŠ¡ [20](#0-19) ï¼š

**ä½¿ç”¨åœºæ™¯**ï¼š
- è¾¹æ•°é‡æœªçŸ¥çš„æƒ…å†µ
- éœ€è¦ä¸åŒçŠ¶æ€ç‰ˆæœ¬çš„å¹¶è¡Œå¤„ç†
- Map-reduce è®¾è®¡æ¨¡å¼

**Send å¯¹è±¡ç»“æ„**ï¼š
- ç¬¬ä¸€ä¸ªå‚æ•°ï¼šç›®æ ‡èŠ‚ç‚¹åç§°
- ç¬¬äºŒä¸ªå‚æ•°ï¼šä¼ é€’ç»™èŠ‚ç‚¹çš„çŠ¶æ€

### 9. Command APIï¼šçŠ¶æ€æ›´æ–°ä¸æ§åˆ¶æµç»“åˆ

Command API å…è®¸åœ¨å•ä¸ªèŠ‚ç‚¹ä¸­åŒæ—¶è¿›è¡ŒçŠ¶æ€æ›´æ–°å’Œæ§åˆ¶æµè·³è½¬ [9](#0-8) ï¼š

**Command å¯¹è±¡å±æ€§**ï¼š
- `update`ï¼šçŠ¶æ€æ›´æ–°å­—å…¸
- `goto`ï¼šç›®æ ‡èŠ‚ç‚¹åç§°
- `graph`ï¼šç›®æ ‡å›¾ï¼ˆæ”¯æŒçˆ¶å›¾å¯¼èˆªï¼‰

**ä½¿ç”¨åœºæ™¯**ï¼šå¤šä»£ç†åˆ‡æ¢ã€åŠ¨æ€æ§åˆ¶æµã€çŠ¶æ€ä¼ é€’

## é«˜çº§æ¶æ„è¯¦è§£

### 10. å­å›¾ç³»ç»Ÿï¼šå±‚æ¬¡åŒ–å›¾ç»“æ„

å­å›¾å…è®¸å°†å›¾ä½œä¸ºèŠ‚ç‚¹åµŒå…¥å…¶ä»–å›¾ä¸­ [10](#0-9) ï¼š

**å­å›¾é€šä¿¡æ¨¡å¼**ï¼š
- **å…±äº«çŠ¶æ€æ¨¡å¼**ï¼šçˆ¶å›¾å’Œå­å›¾å…±äº«çŠ¶æ€é”® [21](#0-20) 
- **ä¸åŒçŠ¶æ€æ¨¡å¼**ï¼šéœ€è¦çŠ¶æ€è½¬æ¢å‡½æ•° [22](#0-21) 

**åº”ç”¨åœºæ™¯**ï¼š
- å¤šä»£ç†ç³»ç»Ÿæ„å»º
- ä»£ç å¤ç”¨å’Œæ¨¡å—åŒ–
- å›¢é˜Ÿåä½œå¼€å‘

### 11. å¤šä»£ç†æ¶æ„ï¼šAgent é—´åè°ƒ

å¤šä»£ç†ç³»ç»Ÿé€šè¿‡å­å›¾å’Œ Command å®ç°ä»£ç†é—´é€šä¿¡ [23](#0-22) ï¼š

**Handoff æœºåˆ¶**ï¼š
- ç›®æ ‡ä»£ç†æŒ‡å®š
- çŠ¶æ€ä¿¡æ¯ä¼ é€’
- è·¨å›¾å¯¼èˆªæ”¯æŒ

**æ¶æ„æ¨¡å¼**ï¼š
- ç›‘ç£è€…æ¨¡å¼
- å±‚æ¬¡åŒ–æ¶æ„
- è‡ªå®šä¹‰å·¥ä½œæµ

### 12. äººæœºäº¤äº’ï¼šä¸­æ–­ä¸æ¢å¤æœºåˆ¶

å›¾æ”¯æŒäººå·¥å¹²é¢„å·¥ä½œæµ [24](#0-23) ï¼š

**ä¸­æ–­æœºåˆ¶**ï¼š
- åŠ¨æ€ä¸­æ–­ï¼š`interrupt()` å‡½æ•°
- é™æ€æ–­ç‚¹ï¼šç¼–è¯‘æ—¶é…ç½®
- çŠ¶æ€ä¿å­˜ï¼šä¾èµ– checkpointer

**æ¢å¤æœºåˆ¶**ï¼š
- Command å¯¹è±¡æ¢å¤
- çŠ¶æ€æ›´æ–°å’Œç»§ç»­æ‰§è¡Œ
- æ”¯æŒå¤šè½®äº¤äº’

## å®é™…åº”ç”¨åœºæ™¯è¯¦è§£

### åŸºç¡€èŠå¤©æœºå™¨äººæ„å»º

ä½¿ç”¨ StateGraph æ„å»ºç®€å•èŠå¤©æœºå™¨äºº [25](#0-24) ï¼š

**æ ¸å¿ƒç»„ä»¶**ï¼š
- çŠ¶æ€å®šä¹‰ï¼šæ¶ˆæ¯åˆ—è¡¨ç®¡ç†
- èŠ‚ç‚¹å‡½æ•°ï¼šLLM è°ƒç”¨é€»è¾‘
- è¾¹è¿æ¥ï¼šç®€å•çš„çº¿æ€§æµç¨‹

### å¤æ‚å·¥ä½œæµç¼–æ’

æ”¯æŒå¤æ‚çš„ä¸šåŠ¡é€»è¾‘ç¼–æ’ [26](#0-25) ï¼š

**å·¥ä½œæµç‰¹ç‚¹**ï¼š
- å¤šæ­¥éª¤å¤„ç†
- æ¡ä»¶åˆ†æ”¯
- çŠ¶æ€ç´¯ç§¯æ›´æ–°

### å¤šä»£ç†åä½œç³»ç»Ÿ

å®ç°å¤šä¸ª AI ä»£ç†çš„åä½œ [27](#0-26) ï¼š

**ç³»ç»Ÿç‰¹ç‚¹**ï¼š
- ä»£ç†é—´çŠ¶æ€å…±äº«
- åŠ¨æ€ä»»åŠ¡åˆ†é…
- å±‚æ¬¡åŒ–ç®¡ç†ç»“æ„

## Notes

Graph æ¦‚å¿µæ˜¯ LangGraph çš„æ ¸å¿ƒæŠ½è±¡ï¼Œå®ƒå°†å¤æ‚çš„ AI å·¥ä½œæµå»ºæ¨¡ä¸ºçŠ¶æ€é©±åŠ¨çš„æœ‰å‘å›¾ã€‚ä¸ä¼ ç»Ÿçš„å‡½æ•°è°ƒç”¨é“¾ä¸åŒï¼ŒLangGraph çš„å›¾æ¨¡å‹æ”¯æŒå¹¶è¡Œæ‰§è¡Œã€æ¡ä»¶åˆ†æ”¯ã€çŠ¶æ€æŒä¹…åŒ–å’Œäººå·¥å¹²é¢„ç­‰é«˜çº§ç‰¹æ€§ã€‚é€šè¿‡ StateGraph ç±»ã€èŠ‚ç‚¹å‡½æ•°ã€è¾¹è¿æ¥å’Œå„ç§æ§åˆ¶æµ APIï¼Œå¼€å‘è€…å¯ä»¥æ„å»ºä»ç®€å•èŠå¤©æœºå™¨äººåˆ°å¤æ‚å¤šä»£ç†ç³»ç»Ÿçš„å„ç§åº”ç”¨ã€‚å›¾çš„ç¼–è¯‘å’Œæ‰§è¡Œæœºåˆ¶åŸºäº Google Pregel ç³»ç»Ÿï¼Œç¡®ä¿äº†é«˜æ•ˆçš„å¹¶è¡Œå¤„ç†å’Œå¯é çš„çŠ¶æ€ç®¡ç†ã€‚

Wiki pages you might want to explore:
- [Human-in-the-Loop Capabilities (langchain-ai/langgraph)](/wiki/langchain-ai/langgraph#4)
- [Persistence System (langchain-ai/langgraph)](/wiki/langchain-ai/langgraph#5)
"""


################################################################################
#
# å®æˆ˜æ¼”ç¤ºï¼šæ„å»ºä¸€ä¸ªè¦†ç›–æ ¸å¿ƒçŸ¥è¯†ç‚¹çš„å¤æ‚ LangGraph å›¾
#
# æœ¬ç¤ºä¾‹å°†æ„å»ºä¸€ä¸ªâ€œå¤šæ™ºèƒ½ä½“ç ”ç©¶å›¢é˜Ÿâ€å·¥ä½œæµï¼Œæ—¨åœ¨æ¼”ç¤º LangGraph çš„æ ¸å¿ƒåŠŸèƒ½ã€‚
# è¿™ä¸ªå›¢é˜Ÿç”±ä¸€ä¸ªâ€œè§„åˆ’å¸ˆâ€å’Œå¤šä¸ªå¹¶è¡Œçš„â€œç ”ç©¶å‘˜â€ä»¥åŠä¸€ä¸ªâ€œæŠ¥å‘Šæ’°å†™è€…â€ç»„æˆã€‚
#
# è¦†ç›–çš„çŸ¥è¯†ç‚¹ï¼ˆå¯¹åº”æ–‡ä»¶é¡¶éƒ¨çš„æ³¨é‡Šç¼–å·ï¼‰ï¼š
# 1. å›¾å®šä¹‰ (StateGraph)
# 2. èŠ‚ç‚¹ç³»ç»Ÿ (Python å‡½æ•°)
# 3. è¾¹è¿æ¥ (å›ºå®šè¾¹ & æ¡ä»¶è¾¹)
# 5. å›¾ç¼–è¯‘ (compile)
# 6. å¹¶è¡Œæ‰§è¡Œ (é€šè¿‡ Send API å®ç°)
# 7. æ¡ä»¶è¾¹ (Conditional Edges)
# 8. Send API (ç”¨äº Map-Reduce æ¨¡å¼)
# 11. å¤šä»£ç†æ¶æ„ (é€šè¿‡ä¸åŒè§’è‰²çš„èŠ‚ç‚¹æ¨¡æ‹Ÿ)
# 12. äººæœºäº¤äº’ (ä¸­æ–­ä¸æ¢å¤)
#
################################################################################

import asyncio
from typing import TypedDict, List, Dict

from langgraph.checkpoint.aiosqlite import AsyncSqliteSaver
from langgraph.graph import StateGraph, END, Send
from langgraph.graph.message import add_messages


# ä¸ºäº†ä½¿ç¤ºä¾‹å¯ç‹¬ç«‹è¿è¡Œï¼Œæˆ‘ä»¬ä½¿ç”¨ mock å‡½æ•°æ¨¡æ‹Ÿ LLM è°ƒç”¨
def mock_planner_llm(topic: str) -> List[str]:
    """æ¨¡æ‹Ÿè§„åˆ’å¸ˆ LLMï¼Œå°†ä¸»é¢˜åˆ†è§£ä¸ºå­ä»»åŠ¡ã€‚"""
    print(f"--- è§„åˆ’å¸ˆæ­£åœ¨ä¸ºä¸»é¢˜ '{topic}' ç”Ÿæˆç ”ç©¶è®¡åˆ’... ---")
    return [
        f"æ¢ç©¶ {topic} çš„å†å²æ¸Šæº",
        f"åˆ†æ {topic} çš„å½“å‰å¸‚åœºç°çŠ¶",
        f"é¢„æµ‹ {topic} çš„æœªæ¥å‘å±•è¶‹åŠ¿",
    ]


def mock_researcher_llm(query: str) -> str:
    """æ¨¡æ‹Ÿç ”ç©¶å‘˜ LLMï¼Œé’ˆå¯¹å­é—®é¢˜è¿›è¡Œâ€œç ”ç©¶â€ã€‚"""
    print(f"--- ç ”ç©¶å‘˜æ­£åœ¨ç ”ç©¶: '{query}'... ---")
    # æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ
    asyncio.sleep(1)
    return f"å…³äº '{query}' çš„è¯¦ç»†ç ”ç©¶æŠ¥å‘Šå†…å®¹..."


def mock_writer_llm(research_data: Dict) -> str:
    """æ¨¡æ‹ŸæŠ¥å‘Šæ’°å†™è€… LLMï¼Œå°†ç ”ç©¶ç»“æœæ•´åˆæˆæœ€ç»ˆæŠ¥å‘Šã€‚"""
    print("--- æŠ¥å‘Šæ’°å†™è€…æ­£åœ¨æ•´åˆæ‰€æœ‰ç ”ç©¶èµ„æ–™ï¼Œç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š... ---")
    report_parts = ["# æœ€ç»ˆç ”ç©¶æŠ¥å‘Š\n\n"]
    for query, result in research_data.items():
        report_parts.append(f"## {query}\n\n{result}\n\n")
    return "".join(report_parts)


# [çŸ¥è¯†ç‚¹ 1] å›¾å®šä¹‰ï¼šä½¿ç”¨ TypedDict å®šä¹‰å›¾çš„çŠ¶æ€ (State)
class ResearchTeamState(TypedDict):
    """å®šä¹‰ç ”ç©¶å›¢é˜Ÿå·¥ä½œæµçš„çŠ¶æ€ã€‚"""
    topic: str
    sub_queries: List[str]
    # `add_messages` æ˜¯ä¸€ç§æ–¹ä¾¿çš„ reducerï¼Œç”¨äºå°†å¹¶è¡Œç ”ç©¶å‘˜èŠ‚ç‚¹è¿”å›çš„ç»“æœèšåˆåˆ°ä¸€ä¸ªåˆ—è¡¨ä¸­
    # æ¯ä¸ªç ”ç©¶å‘˜è¿”å›ä¸€ä¸ªå­—å…¸ {'query': 'result'}ï¼Œæœ€ç»ˆä¼šå½¢æˆä¸€ä¸ªå­—å…¸åˆ—è¡¨
    research_results: Annotated[list[dict], add_messages]
    # èšåˆåçš„ç ”ç©¶æ•°æ®
    aggregated_data: Dict[str, str]
    # æœ€ç»ˆæŠ¥å‘Š
    final_report: str
    # ç”¨äºäººæœºäº¤äº’çš„æ ‡å¿—
    human_review_passed: bool


# [çŸ¥è¯†ç‚¹ 2] èŠ‚ç‚¹ç³»ç»Ÿï¼šæ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯ä¸€ä¸ª Python å‡½æ•°
def planner_node(state: ResearchTeamState):
    """è§„åˆ’å¸ˆèŠ‚ç‚¹ï¼šæ¥æ”¶ä¸»é¢˜ï¼Œç”Ÿæˆç ”ç©¶å­æŸ¥è¯¢ã€‚"""
    queries = mock_planner_llm(state["topic"])
    return {"sub_queries": queries}


async def researcher_node(state: ResearchTeamState):
    """ç ”ç©¶å‘˜èŠ‚ç‚¹ï¼šæ¥æ”¶ä¸€ä¸ªå­æŸ¥è¯¢å¹¶è¿”å›ç ”ç©¶ç»“æœã€‚
    æ³¨æ„ï¼šæ­¤èŠ‚ç‚¹å°†ç”± Send API å¹¶è¡Œè°ƒç”¨ã€‚
    `state['sub_queries']` æ­¤æ—¶æ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼Œä½† `Send` ä¼šä¸ºæ¯ä¸ªä»»åŠ¡ä¼ å…¥ä¸€ä¸ªç‰¹å®šçš„å­æŸ¥è¯¢ã€‚
    """
    # `Send` ä¼šå°†ä»»åŠ¡ç‰¹å®šçš„å€¼æ”¾å…¥çŠ¶æ€ä¸­ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œè¯»å–å®ƒ
    query = state["sub_queries"]
    result = await asyncio.to_thread(mock_researcher_llm, query)
    # è¿”å›çš„ç»“æœå°†é€šè¿‡ `add_messages` èšåˆåˆ° `research_results` åˆ—è¡¨ä¸­
    return {"research_results": [{query: result}]}


def aggregator_node(state: ResearchTeamState):
    """èšåˆèŠ‚ç‚¹ï¼šå°†å¹¶è¡Œç ”ç©¶çš„ç»“æœåˆå¹¶æˆä¸€ä¸ªå­—å…¸ã€‚"""
    print("--- èšåˆæ‰€æœ‰ç ”ç©¶å‘˜çš„æˆæœ... ---")
    aggregated = {}
    for res_dict in state["research_results"]:
        aggregated.update(res_dict)
    return {"aggregated_data": aggregated}


def writer_node(state: ResearchTeamState):
    """æŠ¥å‘Šæ’°å†™èŠ‚ç‚¹ï¼šç”Ÿæˆæœ€ç»ˆæŠ¥å‘Šã€‚"""
    report = mock_writer_llm(state["aggregated_data"])
    return {"final_report": report}


def human_review_node(state: ResearchTeamState):
    """äººæœºäº¤äº’èŠ‚ç‚¹ï¼šæ­¤èŠ‚ç‚¹ä»…ç”¨äºè§¦å‘ä¸­æ–­ï¼Œè®©äººç±»è¿›è¡Œå®¡æ ¸ã€‚"""
    print("--- ç­‰å¾…äººå·¥å®¡æ ¸... ---")
    # å®é™…æ“ä½œåœ¨ä¸­æ–­å’Œæ¢å¤é€»è¾‘ä¸­å®Œæˆ
    return {}


# [çŸ¥è¯†ç‚¹ 7 & 8] æ¡ä»¶è¾¹ & Send API
def router_function(state: ResearchTeamState):
    """è·¯ç”±å‡½æ•°ï¼šå†³å®šä¸‹ä¸€æ­¥æ˜¯ç»“æŸè¿˜æ˜¯åˆ†å‘ä»»åŠ¡ç»™ç ”ç©¶å‘˜ã€‚"""
    print("--- è§„åˆ’å®Œæˆï¼Œå‡†å¤‡åˆ†å‘ç ”ç©¶ä»»åŠ¡... ---")
    # ä½¿ç”¨ Send API ä¸ºæ¯ä¸ªå­æŸ¥è¯¢åŠ¨æ€åˆ›å»ºä¸€ä¸ªå¹¶è¡Œçš„ researcher_node ä»»åŠ¡
    # è¿™æ˜¯ Map-Reduce æ¨¡å¼çš„ä½“ç°
    if not state["sub_queries"]:
        return END
    return [Send("researcher", {"sub_queries": q}) for q in state["sub_queries"]]


def after_review_router(state: ResearchTeamState):
    """å®¡æ ¸åè·¯ç”±ï¼šæ ¹æ®äººå·¥å®¡æ ¸ç»“æœå†³å®šæ˜¯ç”ŸæˆæŠ¥å‘Šè¿˜æ˜¯ç»“æŸã€‚"""
    print("--- äººå·¥å®¡æ ¸ç»“æŸï¼Œè¿›è¡Œè·¯ç”±... ---")
    if state.get("human_review_passed"):
        return "writer"
    else:
        print("--- äººå·¥å®¡æ ¸æœªé€šè¿‡ï¼Œå·¥ä½œæµç»“æŸã€‚ ---")
        return END


# [çŸ¥è¯†ç‚¹ 1, 2, 3] å›¾æ„å»ºï¼šå®šä¹‰çŠ¶æ€ã€æ·»åŠ èŠ‚ç‚¹å’Œè¾¹
graph_builder = StateGraph(ResearchTeamState)

graph_builder.add_node("planner", planner_node)
graph_builder.add_node("researcher", researcher_node)
graph_builder.add_node("aggregator", aggregator_node)
graph_builder.add_node("human_review", human_review_node)
graph_builder.add_node("writer", writer_node)

graph_builder.set_entry_point("planner")

# [çŸ¥è¯†ç‚¹ 6 & 8] ä» planner èŠ‚ç‚¹å‡ºæ¥åï¼Œä½¿ç”¨æ¡ä»¶è·¯ç”±å’Œ Send API å®ç°å¹¶è¡Œæ‰§è¡Œ
graph_builder.add_conditional_edges("planner", router_function)

# [çŸ¥è¯†ç‚¹ 3] æ‰€æœ‰å¹¶è¡Œçš„ researcher èŠ‚ç‚¹å®Œæˆåï¼Œç»“æœä¼šæ±‡é›†åˆ° aggregator èŠ‚ç‚¹
graph_builder.add_edge("researcher", "aggregator")

# èšåˆåè¿›å…¥äººå·¥å®¡æ ¸ç¯èŠ‚
graph_builder.add_edge("aggregator", "human_review")

# [çŸ¥è¯†ç‚¹ 7] æ ¹æ®äººå·¥å®¡æ ¸ç»“æœï¼Œå†³å®šä¸‹ä¸€æ­¥èµ°å‘
graph_builder.add_conditional_edges(
    "human_review",
    after_review_router,
    {"writer": "writer", END: END},
)

graph_builder.add_edge("writer", END)

# [çŸ¥è¯†ç‚¹ 5 & 12] å›¾ç¼–è¯‘ä¸äººæœºäº¤äº’é…ç½®
# ä½¿ç”¨å†…å­˜ä¸­çš„ SQLite ä½œä¸ºæ£€æŸ¥ç‚¹ï¼Œä»¥æ”¯æŒä¸­æ–­å’Œæ¢å¤
memory_saver = AsyncSqliteSaver.new_memory()

research_graph = graph_builder.compile(
    checkpointer=memory_saver,
    # åœ¨ `human_review` èŠ‚ç‚¹ä¹‹å‰ä¸­æ–­ï¼Œä»¥å®ç°äººå·¥å¹²é¢„
    interrupt_before=["human_review"],
)


async def main():
    """ä¸»å‡½æ•°ï¼šæ‰§è¡Œå›¾å¹¶å¤„ç†äººæœºäº¤äº’ã€‚"""
    config = {"configurable": {"thread_id": "research-thread-1"}}
    topic = "äººå·¥æ™ºèƒ½åœ¨è½¯ä»¶å·¥ç¨‹ä¸­çš„åº”ç”¨"
    inputs = {"topic": topic}

    print(f"ğŸš€ å¼€å§‹æ‰§è¡Œç ”ç©¶å·¥ä½œæµï¼Œä¸»é¢˜: {topic}")
    
    # å¼‚æ­¥æ‰§è¡Œå›¾
    async for event in research_graph.astream(inputs, config=config):
        for v in event.values():
            print(f"èŠ‚ç‚¹ '{next(iter(v))}' å·²å®Œæˆã€‚")

    # [çŸ¥è¯†ç‚¹ 12] å¤„ç†ä¸­æ–­
    # æ­¤æ—¶å›¾çš„æ‰§è¡Œå·²åœ¨ `human_review` èŠ‚ç‚¹å‰æš‚åœ
    snapshot = await research_graph.aget_state(config)
    print("\nâ¸ï¸ å·¥ä½œæµå·²ä¸­æ–­ï¼Œç­‰å¾…äººå·¥å®¡æ ¸ã€‚")
    print("å½“å‰ç ”ç©¶æˆæœ:")
    print(snapshot.values["aggregated_data"])

    # æ¨¡æ‹Ÿäººå·¥å®¡æ ¸è¿‡ç¨‹
    user_input = input("ç ”ç©¶æˆæœæ˜¯å¦é€šè¿‡å®¡æ ¸ï¼Ÿ(yes/no): ").strip().lower()
    
    if user_input == 'yes':
        print("âœ… å®¡æ ¸é€šè¿‡ï¼Œç»§ç»­æ‰§è¡Œä»¥ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š...")
        # æ›´æ–°çŠ¶æ€å¹¶æ¢å¤æ‰§è¡Œ
        await research_graph.aupdate_state(
            config, {"human_review_passed": True}
        )
        # ä»ä¸­æ–­å¤„ç»§ç»­æ‰§è¡Œ
        async for event in research_graph.astream(None, config=config):
             for v in event.values():
                print(f"èŠ‚ç‚¹ '{next(iter(v))}' å·²å®Œæˆã€‚")
    else:
        print("âŒ å®¡æ ¸æœªé€šè¿‡ï¼Œå·¥ä½œæµå°†ç»ˆæ­¢ã€‚")
        await research_graph.aupdate_state(
            config, {"human_review_passed": False}
        )
        async for event in research_graph.astream(None, config=config):
             for v in event.values():
                print(f"èŠ‚ç‚¹ '{next(iter(v))}' å·²å®Œæˆã€‚")

    # æ‰“å°æœ€ç»ˆçŠ¶æ€
    final_state = await research_graph.aget_state(config)
    if final_state.values.get("final_report"):
        print("\nğŸ“„ === æœ€ç»ˆæŠ¥å‘Š ===\n")
        print(final_state.values["final_report"])
    else:
        print("\nå·¥ä½œæµå·²ç»“æŸï¼Œæœªç”Ÿæˆæœ€ç»ˆæŠ¥å‘Šã€‚")


if __name__ == "__main__":
    # åœ¨ Python 3.8+ ä¸­ï¼Œå¯ä»¥ç›´æ¥è¿è¡Œ async main
    asyncio.run(main())
